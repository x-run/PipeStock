# UI - 画面仕様

## 0. 技術スタック (Phase 5)

| 項目 | 技術 |
|------|------|
| フレームワーク | React 19 + Vite + TypeScript |
| CSS | Tailwind CSS v4 |
| グラフ | Recharts (PieChart / Donut) |
| アイコン | Lucide React |
| ルーティング | React Router v7 |
| ディレクトリ | `frontend/` |

## 1. 画面一覧

| # | 画面名 | パス | 実装状態 | 説明 |
|---|--------|------|---------|------|
| 1 | ダッシュボード | `/` | Phase 5 実装済 | KPIカード + 棒グラフ + 円グラフ |
| 2 | 在庫一覧 | `/stock` | Phase 5 実装済 | 検索・ソート・ページング付き在庫テーブル |
| 3 | 商品一覧 | `/products` | 未実装 | 商品マスタの管理 |
| 4 | 商品登録/編集 | `/products/new`, `/products/:id/edit` | 未実装 | 商品の作成・更新 |
| 5 | 商品詳細 | `/products/:id` | 未実装 | 商品情報 + Tx 履歴 |
| 6 | Tx 登録 | `/products/:id/transactions/new` | 未実装 | 入庫・出庫・引当・補正の記録 |

## 2. 表示ルール

### 2.1 色の使い分け

| 要素 | 表示スタイル | 理由 |
|------|-------------|------|
| Available | **太字・メインカラー** | 最も重要な数値。主役として目立たせる |
| On-hand | 通常テキスト | 参考値として表示 |
| Reserved | **薄い色 (opacity: 0.5 程度)** | 補助情報として控えめに表示 |
| Reserved のうち返品検品待ち | さらに薄い色 + ラベル「検品待ち」 | 返品由来の Reserved を区別 |
| 発注点以下の商品 | 行の背景色を警告色 (薄いオレンジ/赤) | 注意喚起 |

### 2.2 数値フォーマット

| 項目 | フォーマット | 例 |
|------|-------------|-----|
| 数量 | 整数 + 単位 | `80 本` |
| 単価 | 通貨 (3桁カンマ区切り) | `¥2,500` |
| 金額 | 通貨 (3桁カンマ区切り) | `¥250,000` |
| 重量 | 小数1位 + kg | `320.0 kg` |

---

## 3. 画面詳細

### 3.1 ダッシュボード (`/`) — Phase 5 実装済

数量中心のダッシュボード。全商品の在庫状況を俯瞰する。

**実装レイアウト:**

```
┌─────────────────────────────────────────────────────┐
│ PipeStock                 [ダッシュボード] [在庫一覧] │
├─────────────────────────────────────────────────────┤
│ ┌──────────┐ ┌──────────┐ ┌──────────────┐          │
│ │ 総商品数  │ │ 要発注    │ │ 返品検品待ち  │          │
│ │   25     │ │   3 ⚠   │ │   10 個       │          │
│ └──────────┘ └──────────┘ └──────────────┘          │
├──────────────────────────────┬──────────────────────┤
│ 在庫数量 Top 10 [もっと見る→]│ 在庫構成比 [金額 ▼]   │
│                              │                      │
│ PIPE-001 ████████░░  200 本  │      ╭───────╮       │
│ PIPE-003 ██████░     120 本  │    ╱  total   ╲      │
│ PIPE-002 █████░       80 ⚠  │   │  ¥300,000  │     │
│ …                            │    ╲          ╱      │
│ その他   ███          50 本  │      ╰───────╯       │
│                              │  ● ステンレス ¥200k   │
│ ████ available               │  ● バルブ     ¥ 75k   │
│ ░░░░ 検品待ち                │  ● その他     ¥ 25k   │
└──────────────────────────────┴──────────────────────┘
```

**実装コンポーネント:**
- `KpiCards` — 総商品数 / 要発注 / 返品検品待ち
- `StockBarChart` — 在庫数量 Top N 横棒グラフ
- `CategoryPieChart` — カテゴリ別在庫構成比ドーナツチャート (Recharts)

**実装済み要件:**
- KPIカード: 数量関連を最優先 (総商品数 > 要発注 > 返品検品待ち)
- 棒グラフ: available (blue-500) + reserved_pending_return (blue-200) の積み上げ
- 円グラフ: metric 切替ドロップダウン (金額/数量/利用可能/引当)
- ローディング (スピナー)、エラー (再試行ボタン)、空状態を実装
- 「もっと見る →」で `/stock` に遷移

#### 3.1.1 在庫棒グラフ (Top N)

サマリカードの下、テーブルの上に在庫数量の横棒グラフを表示する。数量固定 (metric 切替なし)。

```
┌─────────────────────────────────────────────────────┐
│ 在庫数量 Top 10                    [もっと見る →]     │
├─────────────────────────────────────────────────────┤
│ PIPE-001 ████████████████████░░░░░░░░  200 本        │
│ PIPE-003 ████████████████░░            120 本        │
│ PIPE-002 ████████████░                  80 本  ⚠    │
│ …                                                    │
│ その他   ████████                       50 本        │
└─────────────────────────────────────────────────────┘
   ████ available   ░░░░ 検品待ち (reserved_pending_return)
```

**データソース:** `GET /api/v1/dashboard/stock/top`

**要件:**
- 棒の内訳 (stacked bar):
  - available 部分を通常色で表示 (棒の主要部分)
  - reserved_pending_return (検品待ち) を薄い色で重ねて表示
- 右端に on_hand の数量 + 単位を表示 (例: `200 本`)
- needs_reorder = true の行にはラベル/アイコンで視覚的に警告
- 最後のバーに others_total を「その他」として表示
- 右上は「もっと見る →」リンクのみ (`/stock` 在庫一覧に遷移)
- limit のデフォルトは 10

#### 3.1.2 在庫構成比円グラフ (Pie Chart)

棒グラフの右横（またはサマリカードエリア）にカテゴリ別の在庫構成比円グラフを表示する。

```
┌─────────────────────────────────────┐
│ 在庫構成比  [金額 ▼]  ← metric 切替 │
├─────────────────────────────────────┤
│                                     │
│         ┌───────────┐               │
│     ╱   │ ¥300,000  │  ╲            │
│    │ A  │  total     │ C │          │
│     ╲   │           │  ╱            │
│         └───────────┘               │
│           B    その他               │
│                                     │
│  ● ステンレスパイプ      ¥200,000    │
│  ● バルブ               ¥ 75,000    │
│  ● その他               ¥ 25,000    │
└─────────────────────────────────────┘
```

**データソース:** `GET /api/v1/dashboard/stock/by-category`

**要件:**
- 中央に total を大きく表示
- metric 切替: 金額 (value) / 数量 (qty) / 利用可能 (available) / 引当 (reserved) のドロップダウン
- TopN + OTHER でスライスを構成
- カテゴリ = 商品名の先頭トークン (全角空白も考慮して正規化)
- limit のデフォルトは 10

### 3.1.3 在庫一覧ページ (`/stock`) — Phase 5 実装済 + MVP在庫操作機能

ダッシュボードの「もっと見る →」遷移先。全商品の在庫を検索・ソート・ページングで確認し、商品追加・入庫・出庫の操作を実行する。

**実装レイアウト:**

```
┌────────────────────────────────────────────────────────────────┐
│ [検索...]                [数量 多い順 ▼]    [+ 商品追加]       │
├──────┬──────┬──────┬────────┬────────┬──────┬───────┬─────────┤
│ Code │ 商品名│ カテゴリ│On-hand │Reserved│Avail │ 状態  │ 操作    │
├──────┼──────┼──────┼────────┼────────┼──────┼───────┼─────────┤
│PIPE  │ステン │ステン │ 100 本 │  20    │**80**│ 正常   │[入庫]   │
│-001  │レス…  │レス…  │        │(薄い色)│(太字)│       │[出庫]   │
├──────┼──────┼──────┼────────┼────────┼──────┼───────┼─────────┤
│PIPE  │銅パイ │銅パイ │   8 本 │   3    │ **5**│⚠ 要発注│[入庫]   │
│-002  │プ…   │プ…   │        │(検品2) │(太字)│⚠背景色│[出庫]   │
└──────┴──────┴──────┴────────┴────────┴──────┴───────┴─────────┘
│ 50 件中 1〜20 件            [◀] 1 / 3 [▶]                    │
└────────────────────────────────────────────────────────────────┘
```

**実装済み要件:**
- **商品追加:** 右上「+ 商品追加」ボタンからモーダルで新規商品を作成
- **在庫操作:** 各商品行の「入庫」「出庫」ボタンから在庫変動を記録
- 検索: code / name / spec 部分一致 (`q` パラメータ)
- ソート: 数量多い順/少ない順、金額多い順/少ない順、更新日新しい順
- ページング: 20件/ページ、前後ナビゲーション
- Available を太字・メインカラー (blue-600) で表示
- Reserved は薄い色 (gray-400)、検品待ちは `(検品N)` ラベル付き
- needs_reorder = true の行は amber-50 背景 + 「要発注」バッジ
- カテゴリ列は商品名の先頭トークンから自動導出
- **トースト通知:** 操作成功時に緑色、エラー時に赤色の通知を表示

#### 3.1.3.1 MVP在庫操作機能

商品追加・入庫・出庫の3つの基本操作を実装。売上管理は対象外。

**1) 商品追加**

```
┌─────────────────────────────────────────┐
│ 商品追加                          [×]   │
├─────────────────────────────────────────┤
│ 商品名 *       [           ]            │
│ 仕様 (任意)    [           ]            │
│ 単価 *         [           ] 円         │
│ 単位重量       [           ] kg         │
│ 発注点 *       [           ]            │
│                                         │
│          [キャンセル] [作成]             │
└─────────────────────────────────────────┘
```

- **起動:** 右上「+ 商品追加」ボタンをクリック
- **入力フィールド:**
  - 商品名（必須）: テキスト入力
  - 仕様（任意）: テキスト入力
  - 単価（必須）: テキスト入力、整数のみ、blur時にカンマ区切り整形
  - 単位重量（任意）: テキスト入力、小数可、blur時に数値整形
  - 発注点（必須）: テキスト入力、整数
- **自動設定項目:**
  - 商品コード: 商品名の先頭3文字 + タイムスタンプ6桁で自動生成
  - 単位: "本" 固定
- **バリデーション:**
  - 各フィールドにフォーカス装飾（青枠）とエラー時は赤枠
  - エラーメッセージをフィールド下に表示
  - 単価は0以上の整数、小数入力時はエラー
  - 重量は0以上の数値、小数可
- **API:** `POST /api/v1/products`
  - body: `{ code, name, spec?, unit="本", unit_price, unit_weight?, reorder_point }`
- **成功後:** モーダルを閉じ、一覧を再取得、トースト表示「商品を追加しました」

**2) 入庫 (IN)**

```
┌─────────────────────────────────────────┐
│ 入庫 — ステンレスパイプ 25A       [×]   │
├─────────────────────────────────────────┤
│ 現在在庫:                                │
│ Available: 80  On-hand: 100             │
├─────────────────────────────────────────┤
│ 数量 *         [     ] 本                │
│                                         │
│ ℹ 入庫理由は「PURCHASE (仕入)」として   │
│   記録されます                           │
│                                         │
│          [キャンセル] [実行]             │
└─────────────────────────────────────────┘
```

- **起動:** 各商品行の「入庫」ボタンをクリック
- **API:** `POST /api/v1/products/{id}/transactions`
  - body: `{ "type": "IN", "qty": <qty>, "reason": "PURCHASE" }`
- **effect:** On-hand 増加、Available 増加
- **成功後:** モーダルを閉じ、一覧を再取得、トースト表示「在庫を更新しました」

**3) 出庫 (OUT)**

```
┌─────────────────────────────────────────┐
│ 出庫 — ステンレスパイプ 25A       [×]   │
├─────────────────────────────────────────┤
│ 現在在庫:                                │
│ Available: 80  On-hand: 100             │
├─────────────────────────────────────────┤
│ 数量 *         [     ] 本                │
│ 用途 *         [選択してください    ▼]  │
│                 ├ 出荷 (SHIP)            │
│                 ├ 移動 (MOVE)            │
│                 ├ 廃棄 (SCRAP)           │
│                 ├ サンプル (SAMPLE)      │
│                 └ その他 (OTHER)         │
│                                         │
│          [キャンセル] [実行]             │
└─────────────────────────────────────────┘
```

- **起動:** 各商品行の「出庫」ボタンをクリック
- **API:** `POST /api/v1/products/{id}/transactions`
  - body: `{ "type": "OUT", "qty": <qty>, "reason": "<用途>" }`
- **effect:** On-hand 減少、Available 減少
- **Available不足時:** `409 Conflict` → エラーメッセージ「在庫が足りません」をモーダル内に表示
- **成功後:** モーダルを閉じ、一覧を再取得、トースト表示「在庫を更新しました」

**共通要件:**
- 数量: 必須、1以上の整数
- エラー時はモーダルを閉じず、エラーメッセージを表示して修正可能
- 成功時はトースト通知（緑色）、エラー時は赤色トーストまたはモーダル内エラー表示

**実装コンポーネント:**
- `CreateProductModal` — 商品追加モーダル
- `TransactionModal` — 入庫・出庫モーダル (type='IN' | 'OUT')
- `Toast` — 通知コンポーネント

---

### 3.2 商品一覧 (`/products`)

**レイアウト:**

```
┌─────────────────────────────────────────────────────┐
│ 商品管理                            [+ 新規登録]     │
├─────────────────────────────────────────────────────┤
│ [検索...]           [アクティブのみ ✓]               │
├──────┬──────┬──────┬──────┬────────┬────────────────┤
│ Code │ 名前  │ 単位 │ 単価  │ 発注点  │ ステータス    │
├──────┼──────┼──────┼──────┼────────┼────────────────┤
│PIPE  │ステン │  本  │¥2,500│  10    │ ● アクティブ   │
│-001  │レス…  │      │      │        │               │
└──────┴──────┴──────┴──────┴────────┴────────────────┘
```

---

### 3.3 商品登録/編集 (`/products/new`, `/products/:id/edit`)

**フォーム構成:**

```
┌─────────────────────────────────────────┐
│ 商品登録 / 商品編集                       │
├─────────────────────────────────────────┤
│ 商品コード *   [PIPE-001           ]    │
│ 商品名 *       [ステンレスパイプ 25A ]    │
│ 仕様           [SUS304 / 外径34mm   ]    │
│ 単位 *         [本                  ]    │
│ 単価 (円) *    [2500                ]    │
│ 単位重量 (kg)  [3.2                 ]    │
│ 発注点 *       [10                  ]    │
│                                         │
│              [キャンセル] [保存]          │
└─────────────────────────────────────────┘
```

**バリデーション:**
- `*` は必須項目
- 商品コードはユニーク (重複時はエラー表示)
- 単価・発注点は 0 以上
- 編集時は楽観ロック (version) を送信

---

### 3.4 商品詳細 (`/products/:id`)

**レイアウト:**

```
┌─────────────────────────────────────────────────────┐
│ ← 戻る     PIPE-001 ステンレスパイプ 25A   [編集]    │
├─────────────────────────────────────────────────────┤
│ 在庫サマリ                                           │
│ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐  │
│ │  Available   │ │   On-hand    │ │  Reserved    │  │
│ │  **80 本**   │ │   100 本     │ │   20 本      │  │
│ │  メインカラー │ │   通常       │ │  (薄い色)    │  │
│ └──────────────┘ └──────────────┘ └──────────────┘  │
│ 在庫金額: ¥250,000    在庫重量: 320.0 kg             │
├─────────────────────────────────────────────────────┤
│ 商品情報                                             ��
│ 仕様: SUS304 / 外径34mm / 肉厚1.5mm                 │
│ 単位: 本  |  単価: ¥2,500  |  重量: 3.2 kg           │
│ 発注点: 10                                           │
├─────────────────────────────────────────────────────┤
│ トランザクション履歴              [+ 新規 Tx]         │
├──────┬──────┬────────┬────────┬──────────────────────┤
│ 日時  │ 種別 │バケット │ 数量    │ 理由                │
├──────┼──────┼────────┼────────┼──────────────────────┤
│01/15 │ IN   │ON_HAND │ +50    │ 仕入先A社より入荷    │
│10:00 │      │        │        │                      │
├──────┼──────┼────────┼────────┼──────────────────────┤
│01/15 │ IN   │RESERVED│ +20   │ 注文#1234 引当       │
│11:00 │      │        │(薄い色)│                      │
└──────┴──────┴────────┴────────┴──────────────────────┘
```

**要件:**
- Available を最も大きく目立つカードで表示
- Reserved 関連の数値は薄い色
- Tx 履歴は新しい順に表示
- RESERVED バケットの Tx 行は薄い色で表示

---

### 3.5 Tx 登録 (`/products/:id/transactions/new`)

**フォーム構成:**

```
┌─────────────────────────────────────────┐
│ トランザクション登録                      │
│ 商品: PIPE-001 ステンレスパイプ 25A      │
├─────────────────────────────────────────┤
│ 現在の在庫:                              │
│ Available: 80 本 | On-hand: 100 本       │
│ Reserved: 20 本 (薄い色)                 │
├─────────────────────────────────────────┤
│ 操作を選択:                              │
│ ○ 入庫 (type=IN)                        │
│ ○ 出庫 (type=OUT)                       │
│ ○ 引当 (type=RESERVE)                   │
│ ○ 引当解除・出荷 (type=OUT + UNRESERVE)  │
│ ○ 返品到着 (type=IN + RESERVE batch)      │
│ ○ 返品検品OK (type=UNRESERVE)            │
│ ○ 返品検品NG・廃棄 (UNRESERVE + OUT batch)│
│ ○ 棚卸補正・増 (type=ADJUST, INCREASE)   │
│ ○ 棚卸補正・減 (type=ADJUST, DECREASE)   │
├─────────────────────────────────────────┤
│ 数量 *         [     ]                   │
│ 理由           [                    ]    │
│                                         │
│              [キャンセル] [登録]          │
└─────────────────────────────────────────┘
```

**要件:**
- 操作をわかりやすいラベルで選択させる (API には type + qty のみ送信、符号はサーバーが決定)
- 「引当解除・出荷」は batch API で OUT + UNRESERVE の2つの Tx を同時に作成
- 「返品到着」は batch API で IN + RESERVE の2つの Tx を同時に作成 (reason: RETURN_ARRIVED / RETURN_PENDING)
- 「返品検品OK」は単一 UNRESERVE (reason: RETURN_OK)
- 「返品検品NG・廃棄」は batch API で UNRESERVE + OUT の2つの Tx を同時に作成 (reason: RETURN_REJECTED / SCRAP)
- 棚卸補正は INCREASE / DECREASE を選択させ、direction として送信
- 出庫系・引当系の操作時は Available チェックの結果をリアルタイムで警告表示
- 登録成功後は商品詳細画面に戻る
